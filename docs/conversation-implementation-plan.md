# CurioProfessor 会話体験実装計画

## 現状分析

### 既存実装
- ✅ UI: 6歳児向けシンプルUI完成
- ✅ STT: Web Speech API（音声認識）
- ✅ Agent選択: 質問内容から専門家を自動選択
- ✅ LLM応答: Gemini経由でテキスト生成
- ✅ 画像生成: Imagen 3で図解生成
- ✅ TTS: OpenAI互換API経由で音声合成

### 課題
- ❌ **6歳児向けペルソナ未実装**: 現在は小学生向け（難しい）
- ❌ **ストリーミング未対応**: 回答完了まで待機（遅い）
- ❌ **並列処理未最適化**: TTS/画像が順次実行（遅い）
- ❌ **会話継続性なし**: 1問1答で終了（学びが深まらない）

---

## 実装計画（優先度順）

### Phase 1: 6歳児向けペルソナ最適化 ⭐⭐⭐
**目的**: 博士が6歳児に分かる言葉で話す

#### 実装内容
1. **プロンプト改善**
   - 対象年齢を「6歳児」に明記
   - ひらがな中心、漢字は最小限
   - 文章を短く（50-80文字）
   - 例え話を必須化

2. **博士ペルソナの統一**
   - 既存の複数エージェント → 単一の「はかせ」に統一
   - 口調: 「～じゃよ」「～なんじゃ」（おじいさん博士）
   - 性格: 優しい、好奇心を褒める、励ます

#### ファイル修正
- `src/lib/agents/core.ts`: `generateExpertResponse()`のプロンプト
- `src/app/actions.ts`: 年齢設定を追加

---

### Phase 2: 体験フロー改善 ⭐⭐⭐
**目的**: 子供が飽きずに学び続けられる

#### 実装内容
1. **会話終了時の問いかけ**
   - 回答後: 「わかったかな？」ボタン表示
   - 選択肢: 「わかった！」「もっときく」

2. **追加質問の促進**
   - 「もっときく」選択時: 関連質問を提案
   - 例: 「じゃあ、○○についても知りたい？」

3. **褒める仕組み**
   - 質問するたびに「いいしつもんじゃ！」
   - セッション終了時: 「きょうは○こ しつもんしたね！」

#### ファイル追加/修正
- `src/components/ConversationFlow.tsx`: 新規作成
- `src/app/page.tsx`: フロー統合

---

### Phase 3: パフォーマンス最適化 ⭐⭐
**目的**: 待ち時間を最小化

#### 実装内容
1. **真の並列処理**
   ```typescript
   Promise.all([
     generateExpertResponse(),  // テキスト生成
     generateIllustration(),    // 画像生成（バックグラウンド）
   ]).then(([text, image]) => {
     generateSpeech(text);      // テキスト完成後すぐTTS
   });
   ```

2. **段階的表示**
   - テキスト生成完了 → すぐ表示 + TTS開始
   - 画像生成完了 → 後から追加表示

#### ファイル修正
- `src/app/actions.ts`: `consultAction()`を並列化

---

### Phase 4: ストリーミング対応（オプション） ⭐
**目的**: さらなる低遅延化

#### 実装内容
- Gemini Streaming API使用
- テキストが生成されるたびに逐次表示
- TTS開始タイミングの最適化

#### 判断基準
- Phase 1-3で体験が十分なら見送り
- 遅延が気になる場合のみ実装

---

## 実装順序

```
1. Phase 1（ペルソナ最適化）← 最優先
   ↓
2. Phase 2（会話フロー）← 体験の核
   ↓
3. Phase 3（並列処理）← 快適性向上
   ↓
4. Phase 4（ストリーミング）← 必要に応じて
```

---

## 次のステップ

### 即座に実装すべき項目
1. **Phase 1: ペルソナ最適化**
   - `generateExpertResponse()`のプロンプト修正
   - 6歳児向けの言葉遣いに変更
   - 文章を短く、ひらがな中心に

2. **Phase 2: 会話フロー**
   - 「わかったかな？」ボタンの実装
   - 追加質問の促進UI

### 実装方針
- **最小限のコード変更**: 既存構造を活かす
- **段階的リリース**: Phase 1 → 2 → 3の順で確認
- **子供でテスト**: 各Phaseで実際の6歳児に試してもらう

---

## 成功指標

### Phase 1完了時
- [ ] 博士の回答が6歳児に理解できる
- [ ] ひらがな中心、短い文章
- [ ] 例え話が含まれる

### Phase 2完了時
- [ ] 1セッションで2-3問の質問ができる
- [ ] 子供が「もっと知りたい」と思える
- [ ] 褒められて嬉しい体験

### Phase 3完了時
- [ ] 回答表示まで5秒以内
- [ ] 音声再生開始まで3秒以内
- [ ] 画像表示まで10秒以内

---

## 技術的な注意点

### 6歳児向けプロンプト設計
```typescript
const PROFESSOR_PERSONA = `
あなたは優しいおじいさん博士です。
6歳の子供に話しかけています。

ルール:
- ひらがなを中心に使う（漢字は「水」「空」など簡単なもののみ）
- 1文は短く（20文字以内）
- 例え話を必ず入れる（「○○みたいに」）
- 子供の好奇心を褒める
- 口調: 「～じゃよ」「～なんじゃ」

回答は50-80文字程度。
`;
```

### 並列処理の実装
```typescript
// 悪い例（順次実行）
const text = await generateText();
const image = await generateImage();
const audio = await generateAudio(text);

// 良い例（並列実行）
const [text, image] = await Promise.all([
  generateText(),
  generateImage()
]);
const audio = await generateAudio(text);
```

---

## まとめ

**最優先**: Phase 1（ペルソナ最適化）
- 既存コードの小さな修正で大きな効果
- 6歳児が理解できる言葉に変更

**次に重要**: Phase 2（会話フロー）
- 学びを深める体験設計
- 「わかったかな？」「もっときく」の実装

実装を開始しますか？
