# Phase 12: Stepwise Visual Explanation (Architecture Plan)

## Overview
Change the current simple "Text + 1 Image" response system to a "Stepwise Explanation" system.
Complex answers will be broken down into 4 steps (or fewer if simple), and the image generation will be optimized to produce a single "Panel Layout" image containing illustrations for all steps to improve performance and cost.

## 1. Data Structure Changes

### New Interfaces (`src/lib/agents/types.ts`)
```typescript
export interface ExplanationStep {
  stepNumber: number;
  text: string;           // The explanation text for this step
  visualDescription: string; // Internal prompt for the image part
}

export interface AgentResponse {
  agentId: AgentRole;
  agentName: string;
  // text: string; // <-- DEPRECATED or kept for fallback
  steps: ExplanationStep[]; // <-- NEW
  imageUrl?: string;
  audioUrl?: string;
  isThinking: boolean;
}
```

## 2. Agent Logic Updates (`src/lib/agents/core.ts`)

### `generateExpertResponse` Refactoring
- **Goal:** Switch from plain text output to structured JSON output.
- **Prompt Strategy:**
  - Instruct the model to analyze complexity.
  - If simple: 1 step.
  - If moderate: 2 steps.
  - If complex: 4 steps.
  - Output format: JSON.
- **Example Prompt Addition:**
  ```text
  Break down the answer into 1 to 4 logical steps.
  Return the response in the following JSON format:
  {
    "steps": [
      { "stepNumber": 1, "text": "First part of explanation...", "visualDescription": "Visual description for step 1..." },
      ...
    ]
  }
  ```

### `generateCombinedImagePrompt` (New Function)
- **Input:** `ExplanationStep[]`
- **Logic:**
  - **1 Step:** Standard full prompt.
  - **2 Steps:** "Split screen, left side shows [visual1], right side shows [visual2]."
  - **4 Steps:** "A comic strip style image divided into 4 equal panels. Top-left: [visual1]. Top-right: [visual2]. Bottom-left: [visual3]. Bottom-right: [visual4]."
- **Output:** A single string prompt for the image model.

## 3. Server Action Updates (`src/app/actions.ts`)

- Update `consultAction` to:
  1. Call `decideAgent`.
  2. Call `generateExpertResponse` (getting JSON steps).
  3. Call `generateCombinedImagePrompt` with the steps.
  4. Call `generateIllustration` (unchanged, just receives the combined prompt).
  5. Return the new `AgentResponse` structure.

## 4. Frontend UI Updates (Future Phase)
*Note: This phase focuses on the backend logic, but UI will need to:*
- Receive the single "Panel Image".
- Display the text steps sequentially.
- (Optional) Use CSS masking (`object-position`) to show the relevant quadrant of the image next to each text step.

## Performance Considerations
- **Token Count:** JSON output might use more tokens, but structured data is safer.
- **Image Generation:** Staying with 1 image call is critical for speed (approx 4-8s vs 4x that).
- **Latency:** The user will see the steps "pop" in. Streaming the steps would be ideal in the future, but for now, we wait for the full JSON.

## 5. Example Output

**Question:** "なぜ空は青いの？" (Why is the sky blue?)
**Agent:** Scientist (Dr. Quark)

### Step 1: JSON Output from Agent
```json
{
  "steps": [
    {
      "stepNumber": 1,
      "text": "太陽の光は、実は虹色のようなたくさんの色が混ざってできているんじゃよ。白く見えるけど、中には赤、青、黄色などがいっぱい詰まっておる。",
      "visualDescription": "A bright sun shining, with a prism effect showing rainbow colors (red, orange, yellow, green, blue, indigo, violet) coming out of the white light."
    },
    {
      "stepNumber": 2,
      "text": "その光が地球の空気（大気）にぶつかると、散らばってしまうんじゃ。これを「散乱」と言うぞ。",
      "visualDescription": "Sunlight rays hitting the Earth's atmosphere. Particles in the air are visible."
    },
    {
      "stepNumber": 3,
      "text": "青い色は、他の色よりもあちこちに散らばりやすい性質を持っておる。だから、空の高いところでは青い光がいっぱい散らばるんじゃ。",
      "visualDescription": "Blue light rays scattering wildly in all directions upon hitting air particles, while red rays pass through mostly straight."
    },
    {
      "stepNumber": 4,
      "text": "その散らばった青い光が私たちの目に届くから、空は青く見えるというわけじゃな！",
      "visualDescription": "A happy child looking up at a beautiful clear blue sky, smiling."
    }
  ]
}
```

### Step 2: Combined Image Prompt (Generated by System)
```text
Create a comic strip style image divided into 4 equal panels. The style should be "children's book illustration, colorful, warm, simple, clean lines".

Panel 1 (Top-Left): A bright sun shining, with a prism effect showing rainbow colors (red, orange, yellow, green, blue, indigo, violet) coming out of the white light.
Panel 2 (Top-Right): Sunlight rays hitting the Earth's atmosphere. Particles in the air are visible.
Panel 3 (Bottom-Left): Blue light rays scattering wildly in all directions upon hitting air particles, while red rays pass through mostly straight.
Panel 4 (Bottom-Right): A happy child looking up at a beautiful clear blue sky, smiling.
```
