# 親側管理画面（ダッシュボード）実装計画

## 📋 概要

親がログイン後、子供のAI会話ログを確認し、学習傾向を把握し、
AIエージェントが「会話のきっかけ」を提案してくれる管理画面を構築する。

### 現状の課題
- 既存の `/report` ページは LocalStorage ベースで Firestore 未連携
- 子供の切り替え機能がレポートに反映されていない
- AIによる会話きっかけ提案機能がない
- 親向けの操作（ブックマーク、メモ、評価）が未実装

### ゴール
- Firestore のデータを活用した親向けダッシュボード
- 子供ごとの学習状況の可視化
- AIエージェントによる「今日の会話きっかけ」提案
- シンプルで温かみのあるUI/UX

---

## 🏗️ アーキテクチャ

### ルート構成

```
/parent/                    → ダッシュボード（メイン画面）
/parent/conversations       → 会話履歴一覧
/parent/conversations/[id]  → 会話詳細
```

### データフロー

```
Firestore
  ├── children/{childId}                    → 子供プロフィール & 統計
  ├── children/{childId}/conversations/     → 会話一覧
  └── children/{childId}/conversations/{id}/scenes/ → シーン詳細
         ↓
  クライアント（React hooks）
         ↓
  UIコンポーネント
         ↓
  AIきっかけ提案（Server Action → Gemini API）
```

---

## 📐 画面設計

### 画面1: ダッシュボード `/parent`

```
┌─────────────────────────────────────────┐
│  ← 戻る          親ダッシュボード        │
├─────────────────────────────────────────┤
│                                         │
│  [子供タブ切り替え: たろう | はなこ]      │
│                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │ 総質問数  │ │ 今週の   │ │ お気に入り│ │
│  │   23     │ │ 質問数 5 │ │ 博士     │ │
│  └──────────┘ └──────────┘ └──────────┘ │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │ 💡 AIからの会話きっかけ提案          │ │
│  │                                     │ │
│  │ 「たろうくんは最近、宇宙に興味が     │ │
│  │  あるみたいです。今夜、一緒に星を    │ │
│  │  見ながら『月はなぜ形が変わるの？』  │ │
│  │  と聞いてみてはいかがでしょう？」    │ │
│  │                                     │ │
│  │  [新しい提案を見る]                  │ │
│  └─────────────────────────────────────┘ │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │ 最近の会話                           │ │
│  │                                     │ │
│  │ 🔬 どうして空は青いの？    2/8 15:30│ │
│  │    クオーク博士 · 5シーン            │ │
│  │                                     │ │
│  │ 🌿 なぜ葉っぱは緑なの？   2/7 16:00│ │
│  │    グリーン隊員 · 4シーン            │ │
│  │                                     │ │
│  │  [すべての会話を見る →]              │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 画面2: 会話履歴一覧 `/parent/conversations`

```
┌─────────────────────────────────────────┐
│  ← 戻る          会話履歴               │
├─────────────────────────────────────────┤
│                                         │
│  [子供タブ切り替え]                      │
│                                         │
│  フィルター: [全て ▼] [新しい順 ▼]      │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │ 🔬 どうして空は青いの？              │ │
│  │ クオーク博士 · 科学への好奇心        │ │
│  │ 2/8 15:30 · 5シーン · ⭐ ブックマーク│ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │ 🌿 なぜ葉っぱは緑なの？             │ │
│  │ グリーン隊員 · 自然への好奇心        │ │
│  │ 2/7 16:00 · 4シーン                 │ │
│  └─────────────────────────────────────┘ │
│  ...                                    │
└─────────────────────────────────────────┘
```

### 画面3: 会話詳細 `/parent/conversations/[id]`

```
┌─────────────────────────────────────────┐
│  ← 戻る          会話詳細               │
├─────────────────────────────────────────┤
│                                         │
│  「どうして空は青いの？」               │
│  クオーク博士 · 2/8 15:30 · 5シーン     │
│                                         │
│  [⭐ ブックマーク] [⭐⭐⭐⭐⭐ 評価]    │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │ シーン 1/5                          │ │
│  │ ┌─────────┐                         │ │
│  │ │  画像   │                         │ │
│  │ └─────────┘                         │ │
│  │ 「ほほう、いい質問じゃな！空が青く   │ │
│  │  見えるのは、太陽の光と空気の関係が  │ │
│  │  あるんじゃよ。」                    │ │
│  └─────────────────────────────────────┘ │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │ 📝 親のメモ                         │ │
│  │ [メモを入力...]                      │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 🔧 実装手順

### Phase 1: 基盤整備（Firestore データ取得層）

#### Step 1.1: 親ダッシュボード用 Firestore 関数の追加
- ファイル: `src/lib/firebase/firestore.ts` に追加
- 追加する関数:
  - `getChildrenByParent(parentUserId)` — 親の全子供プロフィール取得
  - `getConversationWithScenes(childId, conversationId)` — 会話+シーン一括取得
  - `updateConversationFeedback(childId, conversationId, feedback)` — ブックマーク・評価・メモ更新

#### Step 1.2: カスタムフック作成
- ファイル: `src/hooks/useParentDashboard.ts`
- 機能:
  - 子供一覧の取得とキャッシュ
  - アクティブな子供の会話履歴取得
  - ローディング・エラー状態管理

### Phase 2: AIきっかけ提案エージェント

#### Step 2.1: Server Action 作成
- ファイル: `src/app/actions.ts` に追加
- 関数: `generateConversationSuggestion(childId, recentConversations)`
- 処理:
  1. 子供の最近の会話ログ（直近5件）を取得
  2. 子供のプロフィール（年齢、興味）を取得
  3. Gemini に以下のプロンプトを送信:
     - 子供の年齢・興味
     - 最近の質問リスト
     - 「親が子供と会話するきっかけを1つ提案してください」
  4. 結果を返却

#### Step 2.2: プロンプト設計
```
あなたは子育てアドバイザーです。
以下の情報をもとに、親が子供と今日話すきっかけを1つ提案してください。

【子供の情報】
- 名前: {name}
- 年齢: {age}歳
- 最近の興味: {favoriteTopics}

【最近の質問】
{recentQuestions}

【条件】
- 親が自然に切り出せる会話のきっかけにすること
- 子供の興味に関連した内容にすること
- 具体的なシチュエーション（食事中、散歩中など）を含めること
- 2-3文で簡潔にまとめること
- 温かみのある口調で書くこと
```

### Phase 3: UI実装

#### Step 3.1: ダッシュボードページ
- ファイル: `src/app/parent/page.tsx`
- コンポーネント:
  - `ChildSelector` — 子供タブ切り替え
  - `StatsCards` — 統計カード（総質問数、今週の質問数、お気に入り博士）
  - `AISuggestionCard` — AIきっかけ提案カード
  - `RecentConversations` — 最近の会話リスト（5件）

#### Step 3.2: 会話履歴一覧ページ
- ファイル: `src/app/parent/conversations/page.tsx`
- 機能:
  - 会話一覧表示（ページネーション or 無限スクロール → 初期はシンプルに20件表示）
  - フィルター（トピック別、博士別）
  - ブックマーク済みフィルター

#### Step 3.3: 会話詳細ページ
- ファイル: `src/app/parent/conversations/[id]/page.tsx`
- 機能:
  - シーン一覧表示（画像 + テキスト）
  - ブックマーク切り替え
  - 星評価（1-5）
  - 親メモの入力・保存

#### Step 3.4: 既存 `/report` からのリダイレクト
- `/report` → `/parent` にリダイレクト
- メインページのヘッダーリンクも更新

### Phase 4: 仕上げ

#### Step 4.1: レスポンシブ対応
- モバイルファーストで設計（スマホがメインターゲット）
- タブレット・デスクトップでも見やすいレイアウト

#### Step 4.2: ローディング・エラーハンドリング
- Skeleton UI でローディング表示
- エラー時のフォールバック表示
- 空状態（会話がまだない場合）の表示

---

## 📁 ファイル構成

```
src/
├── app/
│   └── parent/
│       ├── page.tsx                          # ダッシュボード
│       ├── layout.tsx                        # 親画面共通レイアウト
│       └── conversations/
│           ├── page.tsx                      # 会話履歴一覧
│           └── [id]/
│               └── page.tsx                  # 会話詳細
├── components/
│   └── parent/
│       ├── ChildSelector.tsx                 # 子供切り替えタブ
│       ├── StatsCards.tsx                    # 統計カード
│       ├── AISuggestionCard.tsx              # AI提案カード
│       ├── RecentConversations.tsx           # 最近の会話リスト
│       ├── ConversationCard.tsx              # 会話カード（一覧用）
│       ├── ConversationDetail.tsx            # 会話詳細表示
│       ├── SceneViewer.tsx                   # シーン表示
│       └── FeedbackControls.tsx              # ブックマーク・評価・メモ
├── hooks/
│   └── useParentDashboard.ts                # ダッシュボード用カスタムフック
└── lib/
    └── firebase/
        └── firestore.ts                     # 既存ファイルに関数追加
```

---

## 🎨 UI/UXデザイン方針

### カラーパレット
- メイン背景: `slate-50` （落ち着いたグレー）
- カードベース: `white` + `shadow-sm`
- アクセント: 子供のメインカラー `sky-500`
- AI提案カード: `amber-50` + `amber-200` border（温かみ）
- 統計カード: 各色アイコンで視覚的に区別

### アニメーション
- ページ遷移: `framer-motion` の `fadeIn`
- カードホバー: `hover:shadow-md transition-shadow`
- AI提案ローディング: パルスアニメーション
- 子供タブ切り替え: スライドアニメーション

### アクセシビリティ
- 十分なコントラスト比
- タッチターゲット 44px 以上
- aria-label の適切な設定
- キーボードナビゲーション対応

### モバイル最適化
- カードは縦1列レイアウト
- 統計カードは横スクロール or 2列グリッド
- 会話リストはタップしやすいサイズ
- 下部に固定ナビゲーションは不要（シンプルに保つ）

---

## 🔐 セキュリティ考慮

- Firestore Security Rules で親子関係を検証済み
- クライアントサイドでも `parentUserId` チェック
- 他の親の子供データにはアクセス不可
- Server Action 内でも認証チェック

---

## 📊 使用する既存リソース

### Firestore 関数（既存）
- `getChildProfile(childId)` — 子供プロフィール取得
- `getRecentConversations(childId, limit)` — 最近の会話取得
- `getCompletedConversations(childId, limit)` — 完了済み会話取得
- `getConversationsByDateRange(childId, start, end)` — 期間指定取得
- `getConversationsByTopic(childId, topic)` — トピック別取得
- `getScenes(childId, conversationId)` — シーン取得

### UIコンポーネント（既存）
- `Card`, `CardHeader`, `CardTitle`, `CardContent`, `CardDescription`
- `Button`, `Input`, `Label`, `Textarea`
- `ScrollArea`, `Select`, `Skeleton`, `Dialog`
- `Avatar`, `Tooltip`, `Progress`, `Accordion`

### コンテキスト（既存）
- `useAuth()` — `parentUserId`, `activeChildId`, `childrenIds`, `selectChild()`

---

## ⏱️ 実装優先度

| 優先度 | 項目 | 工数目安 |
|--------|------|----------|
| 🔴 高 | Phase 1: Firestore関数 + フック | 小 |
| 🔴 高 | Phase 3.1: ダッシュボードページ | 中 |
| 🟡 中 | Phase 2: AIきっかけ提案 | 中 |
| 🟡 中 | Phase 3.2: 会話履歴一覧 | 中 |
| 🟢 低 | Phase 3.3: 会話詳細 | 中 |
| 🟢 低 | Phase 4: 仕上げ | 小 |

---

## 🚀 実装開始チェックリスト

- [x] Firestore スキーマ確認済み
- [x] 既存の認証フロー確認済み
- [x] 既存のUIコンポーネント確認済み
- [x] 既存のFirestore関数確認済み
- [x] データフロー設計完了
- [ ] Phase 1 実装開始
- [ ] Phase 2 実装開始
- [ ] Phase 3 実装開始
- [ ] Phase 4 実装開始
